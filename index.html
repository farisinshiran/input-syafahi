<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Penilaian Ujian</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    .tab-active { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; }
    .tab-inactive { background: #f0fdf4; color: #065f46; }
    .input-score::-webkit-inner-spin-button,
    .input-score::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .input-score { -moz-appearance: textfield; }
    .card-glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    .gradient-bg { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #a7f3d0 100%); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .score-badge { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full gradient-bg">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="sticky top-0 z-50 card-glass border-b border-emerald-200 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 rounded-xl score-badge flex items-center justify-center shadow-lg">
        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <div>
        <h1 id="app-title" class="text-xl font-bold text-emerald-900">Aplikasi Penilaian Ujian</h1>
        <p class="text-sm text-emerald-600">Tahsin &amp; Tahfizh Assessment</p>
       </div>
      </div>
      <div id="record-count" class="hidden px-4 py-2 bg-emerald-100 rounded-full text-emerald-700 font-medium text-sm">
       0 Data
      </div>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="max-w-6xl mx-auto px-4 py-6"><!-- Tab Navigation -->
    <div class="flex gap-2 mb-6"><button id="tab-input" onclick="switchTab('input')" class="tab-active px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg> Input Nilai </button> <button id="tab-data" onclick="switchTab('data')" class="tab-inactive px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg> Data Nilai </button>
    </div><!-- Input Section -->
    <div id="section-input" class="animate-fade"><!-- Student Info -->
     <div class="card-glass rounded-2xl p-6 mb-6 shadow-lg border border-emerald-100">
      <div class="space-y-4">
       <div><label class="block text-sm font-semibold text-emerald-800 mb-2">Nama Peserta</label> <input type="text" id="student-name" placeholder="Masukkan nama peserta ujian" class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-emerald-900 placeholder-emerald-400">
       </div>
       <div><label class="block text-sm font-semibold text-emerald-800 mb-2">Kelas</label> <input type="text" id="student-class" placeholder="Masukkan kelas peserta" class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-emerald-900 placeholder-emerald-400">
       </div>
      </div>
     </div><!-- Exam Type Selection -->
     <div class="card-glass rounded-2xl p-6 mb-6 shadow-lg border border-emerald-100"><label class="block text-sm font-semibold text-emerald-800 mb-3">Jenis Ujian</label>
      <div class="grid grid-cols-2 gap-3"><button id="btn-tahsin" onclick="selectExamType('tahsin')" class="exam-type-btn tab-active px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2"> <span class="text-2xl">ðŸ“–</span> <span id="tahsin-btn-label">Ujian Tahsin</span> </button> <button id="btn-tahfizh" onclick="selectExamType('tahfizh')" class="exam-type-btn tab-inactive px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2"> <span class="text-2xl">ðŸ•Œ</span> <span id="tahfizh-btn-label">Ujian Tahfizh</span> </button>
      </div>
     </div><!-- Tahsin Form -->
     <div id="form-tahsin" class="space-y-4"><!-- Soal 1 -->
      <div class="card-glass rounded-2xl p-6 shadow-lg border border-emerald-100">
       <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full score-badge flex items-center justify-center text-white font-bold">
         1
        </div>
        <h3 class="font-bold text-emerald-900">Soal 1</h3>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Pemahaman Konsep &amp; Definisi <span class="text-emerald-500">(0-70)</span></label> <input type="number" id="tahsin-1-konsep" min="0" max="70" placeholder="0-70" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Kefasihan Pelafalan <span class="text-emerald-500">(0-30)</span></label> <input type="number" id="tahsin-1-fasih" min="0" max="30" placeholder="0-30" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
       </div>
       <div class="mt-3 text-right"><span class="text-sm text-emerald-600">Subtotal: </span> <span id="subtotal-1" class="font-bold text-emerald-800">0</span>
       </div>
      </div><!-- Soal 2 -->
      <div class="card-glass rounded-2xl p-6 shadow-lg border border-emerald-100">
       <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full score-badge flex items-center justify-center text-white font-bold">
         2
        </div>
        <h3 class="font-bold text-emerald-900">Soal 2</h3>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Pemahaman Konsep &amp; Definisi <span class="text-emerald-500">(0-70)</span></label> <input type="number" id="tahsin-2-konsep" min="0" max="70" placeholder="0-70" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Kefasihan Pelafalan <span class="text-emerald-500">(0-30)</span></label> <input type="number" id="tahsin-2-fasih" min="0" max="30" placeholder="0-30" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
       </div>
       <div class="mt-3 text-right"><span class="text-sm text-emerald-600">Subtotal: </span> <span id="subtotal-2" class="font-bold text-emerald-800">0</span>
       </div>
      </div><!-- Soal 3 -->
      <div class="card-glass rounded-2xl p-6 shadow-lg border border-emerald-100">
       <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full score-badge flex items-center justify-center text-white font-bold">
         3
        </div>
        <h3 class="font-bold text-emerald-900">Soal 3</h3>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Pemahaman Konsep &amp; Definisi <span class="text-emerald-500">(0-30)</span></label> <input type="number" id="tahsin-3-konsep" min="0" max="30" placeholder="0-30" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div><label class="block text-sm font-medium text-emerald-700 mb-2">Ketepatan Kaidah Tajwid <span class="text-emerald-500">(0-70)</span></label> <input type="number" id="tahsin-3-tajwid" min="0" max="70" placeholder="0-70" class="input-score w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
       </div>
       <div class="mt-3 text-right"><span class="text-sm text-emerald-600">Subtotal: </span> <span id="subtotal-3" class="font-bold text-emerald-800">0</span>
       </div>
      </div>
     </div><!-- Tahsin Footer Info -->
     <div id="tahsin-footer" class="card-glass rounded-2xl p-6 mt-6 shadow-lg border border-emerald-100 text-center">
      <div class="flex items-center justify-center gap-2 text-emerald-600">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3L9 20M7 20H4a1 1 0 01-1-1V7a1 1 0 011-1h4m6 0h4a1 1 0 011 1v12a1 1 0 01-1 1h-4m-6 0h.01M9 9h.01" />
       </svg>
       <p class="font-medium">Lanjutkan ke Ujian Tahfizh untuk menyimpan data</p>
      </div>
     </div><!-- Tahfizh Form -->
     <div id="form-tahfizh" class="hidden">
      <div class="card-glass rounded-2xl p-6 shadow-lg border border-emerald-100">
       <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-full score-badge flex items-center justify-center"><span class="text-xl">ðŸ•Œ</span>
        </div>
        <div>
         <h3 class="font-bold text-emerald-900" id="tahfizh-form-title">Penilaian Tahfizh</h3>
         <p class="text-sm text-emerald-600">10 Soal (masing-masing 0-100 poin, nilai akhir = Smart Score)</p>
        </div>
       </div>
       <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 1</label> <input type="number" id="tahfizh-1" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 2</label> <input type="number" id="tahfizh-2" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 3</label> <input type="number" id="tahfizh-3" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 4</label> <input type="number" id="tahfizh-4" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 5</label> <input type="number" id="tahfizh-5" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 6</label> <input type="number" id="tahfizh-6" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 7</label> <input type="number" id="tahfizh-7" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 8</label> <input type="number" id="tahfizh-8" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 9</label> <input type="number" id="tahfizh-9" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
        <div class="text-center"><label class="block text-xs font-medium text-emerald-700 mb-2">Soal 10</label> <input type="number" id="tahfizh-10" min="0" max="100" placeholder="0-100" class="input-score w-full px-3 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 outline-none transition-all text-center text-lg font-semibold text-emerald-900">
        </div>
       </div>
      </div><!-- Tahfizh Submit Footer -->
      <div class="card-glass rounded-2xl p-6 mt-6 shadow-lg border border-emerald-100">
       <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-4">
         <div class="text-center">
          <p class="text-sm text-emerald-600 mb-1">Nilai Akhir (Smart Score)</p>
          <div class="px-6 py-3 bg-emerald-100 rounded-xl"><span id="total-score" class="text-3xl font-bold text-emerald-800">0</span> <span class="text-emerald-600 font-medium">/100</span>
          </div>
         </div>
        </div><button id="btn-submit" onclick="submitScore()" class="w-full sm:w-auto px-8 py-4 score-badge text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg><span>Simpan Nilai</span> </button>
       </div>
      </div>
     </div><!-- Toast Message -->
     <div id="toast" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-xl z-50 animate-fade"></div>
    </div><!-- Data Section -->
    <div id="section-data" class="hidden animate-fade"><!-- Filter -->
     <div class="card-glass rounded-2xl p-4 mb-6 shadow-lg border border-emerald-100">
      <div class="flex flex-wrap gap-2"><button onclick="filterData('all')" id="filter-all" class="filter-btn tab-active px-4 py-2 rounded-lg font-medium transition-all">Semua</button> <button onclick="filterData('tahsin')" id="filter-tahsin" class="filter-btn tab-inactive px-4 py-2 rounded-lg font-medium transition-all">Tahsin</button> <button onclick="filterData('tahfizh')" id="filter-tahfizh" class="filter-btn tab-inactive px-4 py-2 rounded-lg font-medium transition-all">Tahfizh</button>
      </div>
     </div><!-- Data List -->
     <div id="data-list" class="space-y-3"><!-- Data cards will be rendered here -->
     </div><!-- Empty State -->
     <div id="empty-state" class="hidden card-glass rounded-2xl p-12 shadow-lg border border-emerald-100 text-center">
      <div class="text-6xl mb-4">
       ðŸ“‹
      </div>
      <h3 class="text-xl font-bold text-emerald-800 mb-2">Belum Ada Data</h3>
      <p class="text-emerald-600">Mulai input nilai untuk melihat data di sini</p>
     </div>
    </div>
   </main><!-- Delete Confirmation Modal -->
   <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 max-w-sm w-full shadow-2xl">
     <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
       <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
       </svg>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-2">Hapus Data?</h3>
      <p class="text-gray-600 mb-6">Data yang dihapus tidak dapat dikembalikan</p>
      <div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-all">Batal</button> <button id="confirm-delete-btn" onclick="confirmDelete()" class="flex-1 px-4 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-all">Hapus</button>
      </div>
     </div>
    </div>
   </div><!-- Incomplete Data Warning Modal -->
   <div id="incomplete-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 max-w-sm w-full shadow-2xl">
     <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-100 flex items-center justify-center">
       <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-2">Data Tidak Lengkap!</h3>
      <p id="incomplete-message" class="text-gray-600 mb-6">Harap isi semua nilai sebelum menyimpan</p><button onclick="closeIncompleteModal()" class="w-full px-4 py-3 bg-amber-600 text-white font-semibold rounded-xl hover:bg-amber-700 transition-all">Mengerti</button>
     </div>
    </div>
   </div><!-- Limit Warning -->
   <div id="limit-warning" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-4 bg-amber-500 text-white rounded-xl shadow-xl z-50 animate-fade">
    <div class="flex items-center gap-3">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
     </svg><span class="font-medium">Batas maksimum 999 data tercapai!</span>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      app_title: 'Aplikasi Penilaian Ujian',
      tahsin_label: 'Ujian Tahsin',
      tahfizh_label: 'Ujian Tahfizh',
      background_color: '#ecfdf5',
      surface_color: '#ffffff',
      text_color: '#065f46',
      primary_action: '#059669',
      secondary_action: '#10b981'
    };

    // Application state
    let currentExamType = 'tahsin';
    let currentFilter = 'all';
    let allRecords = [];
    let deleteTargetId = null;
    let isSubmitting = false;

    // Initialize Element SDK
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (config) => {
        const title = config.app_title || defaultConfig.app_title;
        const tahsinLabel = config.tahsin_label || defaultConfig.tahsin_label;
        const tahfizhLabel = config.tahfizh_label || defaultConfig.tahfizh_label;
        
        document.getElementById('app-title').textContent = title;
        document.getElementById('tahsin-btn-label').textContent = tahsinLabel;
        document.getElementById('tahfizh-btn-label').textContent = tahfizhLabel;
        
        // Update colors
        const bgColor = config.background_color || defaultConfig.background_color;
        const surfaceColor = config.surface_color || defaultConfig.surface_color;
        const textColor = config.text_color || defaultConfig.text_color;
        const primaryAction = config.primary_action || defaultConfig.primary_action;
        const secondaryAction = config.secondary_action || defaultConfig.secondary_action;
        
        document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${adjustColor(bgColor, -10)} 100%)`;
        
        document.querySelectorAll('.card-glass').forEach(el => {
          el.style.backgroundColor = surfaceColor;
        });
        
        document.querySelectorAll('.score-badge').forEach(el => {
          el.style.background = `linear-gradient(135deg, ${secondaryAction} 0%, ${primaryAction} 100%)`;
        });
      },
      mapToCapabilities: (config) => ({
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (v) => window.elementSdk.setConfig({ background_color: v })
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (v) => window.elementSdk.setConfig({ surface_color: v })
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (v) => window.elementSdk.setConfig({ text_color: v })
          },
          {
            get: () => config.primary_action || defaultConfig.primary_action,
            set: (v) => window.elementSdk.setConfig({ primary_action: v })
          },
          {
            get: () => config.secondary_action || defaultConfig.secondary_action,
            set: (v) => window.elementSdk.setConfig({ secondary_action: v })
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['tahsin_label', config.tahsin_label || defaultConfig.tahsin_label],
        ['tahfizh_label', config.tahfizh_label || defaultConfig.tahfizh_label]
      ])
    });

    // Helper function to adjust color brightness
    function adjustColor(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    // Helper function to calculate smart score with auto-detection
    function calculateSmartScore(values) {
      // Hitung mean
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      
      // Hitung standard deviation
      const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
      const stdDev = Math.sqrt(variance);
      
      // Keputusan: jika stdDev < 20, gunakan mean, jika tidak gunakan trimmed mean
      if (stdDev < 20) {
        // Data konsisten - gunakan MEAN
        return {
          score: Math.round(mean),
          method: 'MEAN (Konsisten)',
          stdDev: Math.round(stdDev * 100) / 100
        };
      } else {
        // Data tidak konsisten - gunakan TRIMMED MEAN (hapus 10% terendah & tertinggi)
        const sortedValues = values.slice().sort((a, b) => a - b);
        const trimPercent = Math.ceil(sortedValues.length * 0.1);
        const trimmedValues = sortedValues.slice(trimPercent, sortedValues.length - trimPercent);
        
        const trimmedMean = trimmedValues.length > 0 
          ? trimmedValues.reduce((a, b) => a + b, 0) / trimmedValues.length
          : mean;
        
        return {
          score: Math.round(trimmedMean),
          method: 'TRIMMED MEAN (Outlier Detected)',
          stdDev: Math.round(stdDev * 100) / 100
        };
      }
    }

    // Data SDK handler
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        updateRecordCount();
        renderDataList();
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        showToast('Gagal menginisialisasi penyimpanan data', 'error');
      }
    }
    initDataSdk();

    // Tab switching
    function switchTab(tab) {
      const tabInput = document.getElementById('tab-input');
      const tabData = document.getElementById('tab-data');
      const sectionInput = document.getElementById('section-input');
      const sectionData = document.getElementById('section-data');

      if (tab === 'input') {
        tabInput.className = 'tab-active px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2';
        tabData.className = 'tab-inactive px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2';
        sectionInput.classList.remove('hidden');
        sectionData.classList.add('hidden');
      } else {
        tabData.className = 'tab-active px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2';
        tabInput.className = 'tab-inactive px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md flex items-center gap-2';
        sectionData.classList.remove('hidden');
        sectionInput.classList.add('hidden');
        renderDataList();
      }
    }

    // Exam type selection
    function selectExamType(type) {
      currentExamType = type;
      const btnTahsin = document.getElementById('btn-tahsin');
      const btnTahfizh = document.getElementById('btn-tahfizh');
      const formTahsin = document.getElementById('form-tahsin');
      const formTahfizh = document.getElementById('form-tahfizh');
      const tahsinFooter = document.getElementById('tahsin-footer');

      if (type === 'tahsin') {
        btnTahsin.className = 'exam-type-btn tab-active px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2';
        btnTahfizh.className = 'exam-type-btn tab-inactive px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2';
        formTahsin.classList.remove('hidden');
        formTahfizh.classList.add('hidden');
        tahsinFooter.classList.remove('hidden');
      } else {
        btnTahfizh.className = 'exam-type-btn tab-active px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2';
        btnTahsin.className = 'exam-type-btn tab-inactive px-4 py-4 rounded-xl font-semibold transition-all duration-300 flex flex-col items-center gap-2';
        formTahfizh.classList.remove('hidden');
        formTahsin.classList.add('hidden');
        tahsinFooter.classList.add('hidden');
      }
      calculateTotal();
    }

    // Calculate scores using SMART SCORE
    function calculateTotal() {
      let result;

      if (currentExamType === 'tahsin') {
        // Tahsin: 3 subtotal
        const subtotals = [];
        
        const konsep1 = parseInt(document.getElementById('tahsin-1-konsep').value) || 0;
        const fasih1 = parseInt(document.getElementById('tahsin-1-fasih').value) || 0;
        const sub1 = Math.min(konsep1, 70) + Math.min(fasih1, 30);
        subtotals.push(sub1);
        document.getElementById('subtotal-1').textContent = sub1;

        const konsep2 = parseInt(document.getElementById('tahsin-2-konsep').value) || 0;
        const fasih2 = parseInt(document.getElementById('tahsin-2-fasih').value) || 0;
        const sub2 = Math.min(konsep2, 70) + Math.min(fasih2, 30);
        subtotals.push(sub2);
        document.getElementById('subtotal-2').textContent = sub2;

        const konsep3 = parseInt(document.getElementById('tahsin-3-konsep').value) || 0;
        const tajwid3 = parseInt(document.getElementById('tahsin-3-tajwid').value) || 0;
        const sub3 = Math.min(konsep3, 30) + Math.min(tajwid3, 70);
        subtotals.push(sub3);
        document.getElementById('subtotal-3').textContent = sub3;

        result = calculateSmartScore(subtotals);
        
      } else {
        // Tahfizh: 10 skor
        const scores = [];
        for (let i = 1; i <= 10; i++) {
          const val = parseInt(document.getElementById(`tahfizh-${i}`).value) || 0;
          scores.push(Math.min(val, 100));
        }
        
        result = calculateSmartScore(scores);
      }

      // Tampilkan nilai akhir
      document.getElementById('total-score').textContent = result.score;
      
      // Debug info di console (opsional)
      console.log(`Method: ${result.method}`);
      console.log(`StdDev: ${result.stdDev}`);
      
      return result.score;
    }

    // Add event listeners for score inputs
    document.querySelectorAll('.input-score').forEach(input => {
      input.addEventListener('input', calculateTotal);
    });

    // Validate form completion
    function validateFormCompletion() {
      const studentName = document.getElementById('student-name').value.trim();
      const studentClass = document.getElementById('student-class').value.trim();

      if (!studentName || !studentClass) {
        document.getElementById('incomplete-message').textContent = 'Harap isi nama peserta dan kelas!';
        document.getElementById('incomplete-modal').classList.remove('hidden');
        return false;
      }

      if (currentExamType === 'tahsin') {
        const values = [
          document.getElementById('tahsin-1-konsep').value,
          document.getElementById('tahsin-1-fasih').value,
          document.getElementById('tahsin-2-konsep').value,
          document.getElementById('tahsin-2-fasih').value,
          document.getElementById('tahsin-3-konsep').value,
          document.getElementById('tahsin-3-tajwid').value
        ];
        
        if (values.some(v => v === '')) {
          document.getElementById('incomplete-message').textContent = 'Harap isi semua nilai Tahsin! Jangan biarkan ada kolom kosong.';
          document.getElementById('incomplete-modal').classList.remove('hidden');
          return false;
        }
      } else {
        const values = [];
        for (let i = 1; i <= 10; i++) {
          values.push(document.getElementById(`tahfizh-${i}`).value);
        }
        
        if (values.some(v => v === '')) {
          document.getElementById('incomplete-message').textContent = 'Harap isi semua 10 soal Tahfizh! Jangan biarkan ada kolom kosong.';
          document.getElementById('incomplete-modal').classList.remove('hidden');
          return false;
        }
      }

      return true;
    }

    // Submit score
    async function submitScore() {
      if (isSubmitting) return;

      if (!validateFormCompletion()) {
        return;
      }

      if (allRecords.length >= 999) {
        document.getElementById('limit-warning').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('limit-warning').classList.add('hidden');
        }, 3000);
        return;
      }

      isSubmitting = true;
      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Menyimpan...</span>';

      const studentName = document.getElementById('student-name').value.trim();
      const studentClass = document.getElementById('student-class').value.trim();
      const median = calculateTotal();
      const record = {
        id: Date.now().toString(),
        student_name: studentName,
        student_class: studentClass,
        exam_type: currentExamType,
        tahsin_1_konsep: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-1-konsep').value) || 0 : 0,
        tahsin_1_fasih: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-1-fasih').value) || 0 : 0,
        tahsin_2_konsep: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-2-konsep').value) || 0 : 0,
        tahsin_2_fasih: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-2-fasih').value) || 0 : 0,
        tahsin_3_konsep: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-3-konsep').value) || 0 : 0,
        tahsin_3_tajwid: currentExamType === 'tahsin' ? parseInt(document.getElementById('tahsin-3-tajwid').value) || 0 : 0,
        tahfizh_1: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-1').value) || 0 : 0,
        tahfizh_2: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-2').value) || 0 : 0,
        tahfizh_3: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-3').value) || 0 : 0,
        tahfizh_4: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-4').value) || 0 : 0,
        tahfizh_5: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-5').value) || 0 : 0,
        tahfizh_6: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-6').value) || 0 : 0,
        tahfizh_7: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-7').value) || 0 : 0,
        tahfizh_8: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-8').value) || 0 : 0,
        tahfizh_9: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-9').value) || 0 : 0,
        tahfizh_10: currentExamType === 'tahfizh' ? parseInt(document.getElementById('tahfizh-10').value) || 0 : 0,
        total_score: median,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(record);

      if (result.isOk) {
        showToast('Nilai berhasil disimpan!', 'success');
        resetForm();
      } else {
        showToast('Gagal menyimpan nilai', 'error');
      }

      isSubmitting = false;
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>Simpan Nilai</span>';
    }

    // Reset form
    function resetForm() {
      document.getElementById('student-name').value = '';
      document.getElementById('student-class').value = '';
      document.querySelectorAll('.input-score').forEach(input => {
        input.value = '';
      });
      document.getElementById('subtotal-1').textContent = '0';
      document.getElementById('subtotal-2').textContent = '0';
      document.getElementById('subtotal-3').textContent = '0';
      document.getElementById('total-score').textContent = '0';
    }

    // Filter data
    function filterData(filter) {
      currentFilter = filter;
      const filters = ['all', 'tahsin', 'tahfizh'];
      filters.forEach(f => {
        const btn = document.getElementById(`filter-${f}`);
        if (f === filter) {
          btn.className = 'filter-btn tab-active px-4 py-2 rounded-lg font-medium transition-all';
        } else {
          btn.className = 'filter-btn tab-inactive px-4 py-2 rounded-lg font-medium transition-all';
        }
      });
      renderDataList();
    }

    // Render data list
    function renderDataList() {
      const container = document.getElementById('data-list');
      const emptyState = document.getElementById('empty-state');

      let filteredRecords = allRecords;
      if (currentFilter !== 'all') {
        filteredRecords = allRecords.filter(r => r.exam_type === currentFilter);
      }

      filteredRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      if (filteredRecords.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      const existingCards = new Map([...container.children].map(el => [el.dataset.recordId, el]));

      filteredRecords.forEach(record => {
        if (existingCards.has(record.__backendId)) {
          updateDataCard(existingCards.get(record.__backendId), record);
          existingCards.delete(record.__backendId);
        } else {
          container.appendChild(createDataCard(record));
        }
      });

      existingCards.forEach(el => el.remove());
    }

    // Create data card
    function createDataCard(record) {
      const card = document.createElement('div');
      card.className = 'card-glass rounded-2xl p-5 shadow-lg border border-emerald-100 animate-fade';
      card.dataset.recordId = record.__backendId;
      
      updateDataCard(card, record);
      return card;
    }

    // Update data card
    function updateDataCard(card, record) {
      const date = new Date(record.created_at);
      const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      let detailHtml = '';
      if (record.exam_type === 'tahsin') {
        detailHtml = `
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="bg-emerald-50 rounded-lg p-2 text-center">
              <div class="text-emerald-600">Soal 1</div>
              <div class="font-semibold text-emerald-800">${record.tahsin_1_konsep + record.tahsin_1_fasih}</div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-2 text-center">
              <div class="text-emerald-600">Soal 2</div>
              <div class="font-semibold text-emerald-800">${record.tahsin_2_konsep + record.tahsin_2_fasih}</div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-2 text-center">
              <div class="text-emerald-600">Soal 3</div>
              <div class="font-semibold text-emerald-800">${record.tahsin_3_konsep + record.tahsin_3_tajwid}</div>
            </div>
          </div>
        `;
      } else {
        detailHtml = `
          <div class="grid grid-cols-5 gap-1 text-xs">
            ${[1,2,3,4,5,6,7,8,9,10].map(i => `
              <div class="bg-emerald-50 rounded p-1 text-center">
                <div class="text-emerald-600 text-[10px]">S${i}</div>
                <div class="font-semibold text-emerald-800">${record[`tahfizh_${i}`]}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      card.innerHTML = `
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full ${record.exam_type === 'tahsin' ? 'bg-blue-100' : 'bg-purple-100'} flex items-center justify-center text-2xl">
              ${record.exam_type === 'tahsin' ? 'ðŸ“–' : 'ðŸ•Œ'}
            </div>
            <div>
              <h4 class="font-bold text-emerald-900">${record.student_name}</h4>
              <p class="text-xs text-emerald-600">Kelas ${record.student_class} â€¢ ${record.exam_type === 'tahsin' ? 'Ujian Tahsin' : 'Ujian Tahfizh'} â€¢ ${dateStr}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-right">
              <div class="text-2xl font-bold text-emerald-800">${record.total_score}</div>
              <div class="text-xs text-emerald-600">Nilai Akhir</div>
            </div>
            <button onclick="showDeleteModal('${record.__backendId}')" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
        ${detailHtml}
      `;
    }

    // Update record count
    function updateRecordCount() {
      const countEl = document.getElementById('record-count');
      if (allRecords.length > 0) {
        countEl.textContent = `${allRecords.length} Data`;
        countEl.classList.remove('hidden');
      } else {
        countEl.classList.add('hidden');
      }
    }

    // Delete modal functions
    function showDeleteModal(id) {
      deleteTargetId = id;
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      deleteTargetId = null;
      document.getElementById('delete-modal').classList.add('hidden');
    }

    // Incomplete modal functions
    function closeIncompleteModal() {
      document.getElementById('incomplete-modal').classList.add('hidden');
    }

    async function confirmDelete() {
      if (!deleteTargetId) return;

      const record = allRecords.find(r => r.__backendId === deleteTargetId);
      if (!record) return;

      const btn = document.getElementById('confirm-delete-btn');
      btn.disabled = true;
      btn.textContent = 'Menghapus...';

      const result = await window.dataSdk.delete(record);

      if (result.isOk) {
        showToast('Data berhasil dihapus', 'success');
      } else {
        showToast('Gagal menghapus data', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Hapus';
      closeDeleteModal();
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-xl z-50 animate-fade ${type === 'success' ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'}`;
      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cdbf09c15249f86',t:'MTc3MTA2NTU0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
